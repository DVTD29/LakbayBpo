<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytics - Transport System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* (same CSS as your dashboard/plan for sidebar, topbar, etc.) */
    :root {
      --main-bg: #f4f7fc;
      --outer-container-bg: #fff;
      --sidebar-bg: #253a77;
      --sidebar-text: #fff;
      --sidebar-radius: 22px;
      --container-radius: 32px;
      --accent: #4670e8;
    }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--main-bg); font-family: 'Segoe UI', Arial, sans-serif; }
    .outer-container {
      min-height: 97vh; max-width: 97vw; margin: 18px auto 18px auto; background: var(--outer-container-bg);
      border-radius: var(--container-radius); box-shadow: 0 8px 50px rgba(60,60,110,0.09), 0 1.5px 8px rgba(120,120,170,0.08);
      display: grid; grid-template-columns: 230px 1fr; padding: 0; position: relative; overflow: hidden;
    }
    .sidebar {
      background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 32px 0 24px 0;
      border-radius: var(--sidebar-radius) 0 0 var(--sidebar-radius); margin: 18px 0 18px 18px; min-height: calc(100vh - 36px);
      width: 210px; box-shadow: 0 0 28px rgba(60,60,110,0.06);
    }
    .sidebar .logo { font-size: 1.35rem; font-weight: bold; letter-spacing: 0.5px; margin-bottom: 36px; text-align: center; }
    .sidebar nav { flex: 1; }
    .sidebar nav a {
      display: flex; align-items: center; color: #e2e8f0; text-decoration: none; font-size: 1.06rem;
      padding: 13px 24px; border-left: 4px solid transparent; transition: background .15s, border .2s, color .2s;
      margin-bottom: 7px; border-radius: 10px; gap: 10px;
    }
    .sidebar nav a.active, .sidebar nav a:hover { background: rgba(255,255,255,0.08); color: #fff; border-left: 4px solid var(--accent);}
    .sidebar nav a .icon { font-size: 1.18rem; width: 24px; text-align: center; }
    .sidebar .sidebar-actions {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .sidebar .sidebar-btn {
      width: 100%;
      margin: 7px 0 0 0;
      background: none;
      color: #e2e8f0;
      border: none;
      font-size: 1.06rem;
      opacity: .85;
      padding: 13px 24px;
      text-align: left;
      border-radius: 10px;
      cursor: pointer;
      transition: background .13s, color .13s, opacity .2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar .sidebar-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.08);
      color: #fff;
    }
    .sidebar .sidebar-btn.logout {
      color: #ffb7b7;
    }
    .main-content-area {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 0 32px 32px 12px;
      background: transparent;
    }
    .topbar {
      height: 58px; margin: 32px 0 22px 0; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(80,100,180,0.07);
      display: flex; align-items: center; justify-content: space-between; padding: 0 32px;
    }
    .topbar .greet { font-size: 1.11rem; color: #333; font-weight: 500;}
    .topbar .profile {
      display: flex; align-items: center; gap: 0; cursor: pointer; text-decoration: none;
    }
    .topbar .profile .circle {
      background: #253a77; color: #fff; font-weight: bold; width: 38px; height: 38px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 1.08rem; overflow: hidden; object-fit: cover;
    }
    .main {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 80vh;
    }
    .analytics-container {
      background: #fff; border-radius: 18px; box-shadow: 0 4px 18px rgba(60,60,110,0.07);
      padding: 36px 28px 28px 28px;
      margin: 36px auto 0 auto;
      max-width: 820px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .analytics-title { color: #253a77; font-size: 1.35rem; font-weight: 600; margin-bottom: 14px; letter-spacing: 0.4px; text-align: center;}
    .analytics-desc { color: #555; font-size: 1.03rem; margin-bottom: 25px; text-align: center;}
    .chart-section {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: space-around;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .chart-card {
      background: #f7fafd;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(80,100,180,0.05);
      padding: 18px 20px 16px 20px;
      flex: 1 1 260px;
      max-width: 340px;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chart-title { font-size: 1.02rem; color: #2644a7; font-weight: 600; margin-bottom: 11px;}
    canvas { width: 100% !important; height: 220px !important;}
    @media (max-width: 900px) {
      .outer-container { grid-template-columns: 60px 1fr; padding: 0;}
      .sidebar { padding: 18px 0 10px 0; margin: 9px 0 9px 9px; min-width: 60px;}
      .sidebar .logo { font-size: 0.97rem; }
      .main-content-area { padding: 0 4vw 12px 1vw;}
      .topbar { margin: 11px 0 12px 0; padding: 0 8px;}
      .main { margin-top: 0;}
      .analytics-container {padding: 20px 4vw;}
      .chart-section {flex-direction: column; gap: 18px;}
    }
    .profile-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; display: block;}
  </style>
</head>
<body>
<script>
  const loggedInUser = localStorage.getItem('loggedInUser');
  if (!loggedInUser) { window.location.href = "login.html"; }
</script>
<div class="outer-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">üöå <span style="font-weight:600;">LakbayBPO</span></div>
    <nav>
      <a href="dashboard.html"><span class="icon">üè†</span>Dashboard</a>
      <a href="plan.html"><span class="icon">üó∫Ô∏è</span>Plan Route</a>
      <a href="fare.html"><span class="icon">üí∏</span>Fare Rates</a>
      <a href="triphistory.html"><span class="icon">üìã</span>Trip History</a>
      <a href="analytics.html" class="active"><span class="icon">üìä</span>Analytics</a>
    </nav>
    <div class="sidebar-actions">
      <button class="sidebar-btn" onclick="openFeedback()">
        <span class="icon">üí¨</span>Feedback
      </button>
      <button class="sidebar-btn logout" onclick="logoutUser(); return false;">
        ‚èè Logout
      </button>
    </div>
  </aside>
  <!-- Main Content Area -->
  <div class="main-content-area">
    <!-- Top Bar -->
    <div class="topbar">
      <span class="greet" id="greetMsg">Good day!</span>
      <a href="profile.html" class="profile">
        <span id="profileCircle" class="circle"></span>
      </a>
    </div>
    <main class="main">
      <div class="analytics-container">
        <div class="analytics-title">Commuter Analytics</div>
        <div class="analytics-desc">Visualize your fare spending, route preferences, and transport choices.<br>Data updates as you use the system.</div>
        <div class="chart-section">
          <div class="chart-card">
            <div class="chart-title">Fare per Month</div>
            <canvas id="barFareMonth"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Transport Modes</div>
            <canvas id="pieModes"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Trips per Week</div>
            <canvas id="lineTripsWeek"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>
  <!-- Feedback Modal (Optional, if using in your app) -->
  <div class="modal-backdrop" id="feedbackModal" style="display:none;">
    <div class="modal">
      <h2>Send Feedback</h2>
      <form onsubmit="submitFeedback(event)">
        <textarea required placeholder="Type your feedback here..." rows="5"></textarea>
        <div class="modal-actions">
          <button type="button" onclick="closeFeedback()">Cancel</button>
          <button type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
if (loggedInUser) {
  function setProfileCircle() {
    let photo = localStorage.getItem('profilePhoto_' + loggedInUser);
    const circle = document.getElementById('profileCircle');
    if (photo) {
      circle.innerHTML = `<img src="${photo}" alt="Profile" class="profile-img" />`;
    } else {
      let initials = loggedInUser.length === 1
        ? loggedInUser[0].toUpperCase()
        : (loggedInUser[0] + loggedInUser.slice(-1)).toUpperCase();
      circle.textContent = initials;
      circle.style.background = "#253a77";
      circle.style.color = "#fff";
    }
  }
  setProfileCircle();
  document.getElementById('greetMsg').textContent = `Good day!`;
}
function logoutUser() { localStorage.removeItem('loggedInUser'); window.location.href = 'login.html'; }

// ===== FEEDBACK MODAL LOGIC =====
function openFeedback() { document.getElementById('feedbackModal').style.display = 'flex'; }
function closeFeedback() { document.getElementById('feedbackModal').style.display = 'none'; }
function submitFeedback(e) { e.preventDefault(); alert("Thank you for your feedback!"); closeFeedback(); }

// ====== CHART DATA LOGIC ======
function getTripData() {
  let user = localStorage.getItem('loggedInUser');
  let trips = JSON.parse(localStorage.getItem('trips_' + user) || "[]");
  return trips;
}
function getMonthLabel(date) {
  let d = new Date(date);
  return d.toLocaleString('en-US', { month: 'short', year: '2-digit' });
}
function getWeekLabel(date) {
  let d = new Date(date);
  // get Monday of this week
  let monday = new Date(d.setDate(d.getDate() - d.getDay() + 1));
  return monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function drawCharts() {
  const trips = getTripData();

  // --- FARE PER MONTH (Bar Chart, last 6 months) ---
  let monthMap = {};
  trips.forEach(trip => {
    let lbl = getMonthLabel(trip.date);
    monthMap[lbl] = (monthMap[lbl] || 0) + Number(trip.fare);
  });
  let monthLabels = Object.keys(monthMap).slice(-6);
  let monthData = monthLabels.map(m => monthMap[m]);

  // --- TRANSPORT MODES (Pie Chart) ---
  let modeMap = {};
  trips.forEach(trip => {
    // Main transport mode
    if(trip.details && trip.details.main) {
      if(Array.isArray(trip.details.main)) {
        trip.details.main.forEach(seg => {
          modeMap[seg.mode] = (modeMap[seg.mode] || 0) + 1;
        });
      } else if(typeof trip.details.main === 'object' && trip.details.main.mode) {
        modeMap[trip.details.main.mode] = (modeMap[trip.details.main.mode] || 0) + 1;
      }
    }
  });
  let modeLabels = Object.keys(modeMap).length > 0 ? Object.keys(modeMap) : ['N/A'];
  let modeData = modeLabels.map(k => modeMap[k] || 0);

  // --- TRIPS PER WEEK (Line Chart, last 6 weeks) ---
  let weekMap = {};
  trips.forEach(trip => {
    let date = new Date(trip.date);
    // get ISO week number
    let year = date.getFullYear();
    let onejan = new Date(date.getFullYear(),0,1);
    let week = Math.ceil((((date - onejan) / 86400000) + onejan.getDay()+1)/7);
    let label = `${year}-W${week}`;
    weekMap[label] = (weekMap[label] || 0) + 1;
  });
  let weekLabels = Object.keys(weekMap).slice(-6);
  let weekData = weekLabels.map(w => weekMap[w]);

  // --- Chart.js Drawing ---
  // Bar: Fare per Month
  new Chart(document.getElementById('barFareMonth').getContext('2d'), {
    type: 'bar',
    data: { labels: monthLabels, datasets: [{ label: 'Total Fare (‚Ç±)', data: monthData, backgroundColor: '#4670e8'}] },
    options: { plugins: { legend: { display: false } }, responsive: true, scales: { y: { beginAtZero: true } } }
  });
  // Pie: Modes
  new Chart(document.getElementById('pieModes').getContext('2d'), {
    type: 'pie',
    data: { labels: modeLabels, datasets: [{ data: modeData, backgroundColor: ['#4670e8','#1fcaa6','#ffba63','#b37ed6','#ed6060','#c7e075'] }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
  // Line: Trips per Week
  new Chart(document.getElementById('lineTripsWeek').getContext('2d'), {
    type: 'line',
    data: { labels: weekLabels, datasets: [{ label: 'Trips', data: weekData, fill: false, borderColor: '#197a39', tension: .38, pointBackgroundColor: '#4670e8'}] },
    options: { plugins: { legend: { display: false } }, responsive: true, scales: { y: { beginAtZero: true } } }
  });
}
drawCharts();
</script>
</body>
</html>
